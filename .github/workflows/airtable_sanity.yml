name: airtable_sanity

on:
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    env:
      AIRTABLE_API_KEY: ${{ secrets.AIRTABLE_API_KEY }}
      AIRTABLE_BASE_ID: ${{ secrets.AIRTABLE_BASE_ID }}
      AIRTABLE_TABLE_NAME: ${{ secrets.AIRTABLE_TABLE_NAME }}

    steps:
      - name: Show secrets presence and lengths (no fail-fast)
        shell: bash
        continue-on-error: true
        run: |
          for k in AIRTABLE_API_KEY AIRTABLE_BASE_ID AIRTABLE_TABLE_NAME; do
            v="${!k}"
            if [ -z "$v" ]; then
              echo "❌ $k is MISSING (length 0)"
            else
              echo "✅ $k present (length ${#v})"
            fi
          done

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install requests
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: List bases token can access  (needs schema.bases:read)
        if: env.AIRTABLE_API_KEY != ''
        continue-on-error: true
        run: |
          python - <<'PY'
          import os, requests
          key=os.environ['AIRTABLE_API_KEY'].strip()
          r=requests.get("https://api.airtable.com/v0/meta/bases",
                         headers={"Authorization":f"Bearer {key}"})
          print("HTTP", r.status_code)
          print(r.text[:1500])
          PY

      - name: List tables in your AIRTABLE_BASE_ID
        if: env.AIRTABLE_API_KEY != '' && env.AIRTABLE_BASE_ID != ''
        continue-on-error: true
        run: |
          python - <<'PY'
          import os, requests
          key=os.environ['AIRTABLE_API_KEY'].strip()
          base=os.environ['AIRTABLE_BASE_ID'].strip()
          url=f"https://api.airtable.com/v0/meta/bases/{base}/tables"
          r=requests.get(url, headers={"Authorization":f"Bearer {key}"})
          print("HTTP", r.status_code)
          print(r.text[:2000])
          PY

      - name: GET 1 record from table (read test)
        if: env.AIRTABLE_API_KEY != '' && env.AIRTABLE_BASE_ID != '' && env.AIRTABLE_TABLE_NAME != ''
        continue-on-error: true
        run: |
          python - <<'PY'
          import os, requests
          key=os.environ['AIRTABLE_API_KEY'].strip()
          base=os.environ['AIRTABLE_BASE_ID'].strip()
          table=os.environ['AIRTABLE_TABLE_NAME'].strip()
          url=f"https://api.airtable.com/v0/{base}/{table}?maxRecords=1"
          r=requests.get(url, headers={"Authorization":f"Bearer {key}"})
          print("HTTP", r.status_code)
          print(r.text[:1000])
          PY

      - name: POST a test row (write test)
        if: env.AIRTABLE_API_KEY != '' && env.AIRTABLE_BASE_ID != '' && env.AIRTABLE_TABLE_NAME != ''
        continue-on-error: true
        run: |
          python - <<'PY'
          import os, requests, json
          key=os.environ['AIRTABLE_API_KEY'].strip()
          base=os.environ['AIRTABLE_BASE_ID'].strip()
          table=os.environ['AIRTABLE_TABLE_NAME'].strip()
          url=f"https://api.airtable.com/v0/{base}/{table}"
          headers={"Authorization":f"Bearer {key}","Content-Type":"application/json"}
          payload={"records":[{"fields":{"full_name":"_SMOKE_TEST_DELETE_ME","status":"Candidate"}}],"typecast":True}
          r=requests.post(url, headers=headers, data=json.dumps(payload))
          print("HTTP", r.status_code)
          print(r.text[:1000])
          PY
